
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <title>오프라인 가계부</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />

  <!-- ✅ XLSX(엑셀) 라이브러리: 루트에 xlsx.full.min.js 필요 -->
  <script src="/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1020; --text:#e9ecf5; --muted:#aab2d5; --line:rgba(255,255,255,.10);
      --good:#2dd4bf; --bad:#fb7185; --warn:#fbbf24;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }
<div style="position:fixed;top:8px;left:8px;z-index:99999;background:#ff0;color:#000;padding:6px 8px;border-radius:8px;font-weight:900">
  LEDGER LOADED ✅
</div>
    
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, #182357 0%, var(--bg) 55%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", Arial, sans-serif;
      line-height:1.4;
    }
    .appHeader{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(10, 14, 30, .72);
      border-bottom:1px solid var(--line);
    }
    .headerInner{
      max-width:1100px; margin:0 auto; padding:12px 14px;
      display:flex; align-items:center; justify-content:center;
    }
    .navTabs{
      display:flex; gap:8px; flex-wrap:nowrap; justify-content:center;
      overflow-x:auto; -webkit-overflow-scrolling: touch; padding-bottom:2px;
    }
    .navTabs::-webkit-scrollbar{ height:0; }
    .navBtn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      transition: .12s transform ease, .12s background ease, .12s border ease;
      white-space:nowrap;
      flex: 0 0 auto;
    }
    .navBtn:hover{ transform: translateY(-1px); }
    .navBtn.active{
      background: linear-gradient(180deg, rgba(45,212,191,.25), rgba(45,212,191,.08));
      border-color: rgba(45,212,191,.35);
    }

    main{ max-width:1100px; margin:0 auto; padding:18px 14px 40px; }
    .page{ display:none; }
    .page.active{ display:block; }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .card{
      grid-column: span 12;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .cardTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }
    .cardTitle h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .muted{ color:var(--muted); }

    .statGrid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .stat{ grid-column: span 12; padding:14px; }
    @media (min-width: 720px){
      .stat{ grid-column: span 4; }
      .card.half{ grid-column: span 6; }
    }
    .statLabel{ color:var(--muted); font-size:12px; margin-bottom:6px; }
    .statValue{ font-size:22px; font-weight:900; letter-spacing:.2px; }
    .good{ color:var(--good); }
    .bad{ color:var(--bad); }
    .warn{ color:var(--warn); }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .spacer{ flex:1; }

    select, textarea,
    input[type="date"], input[type="week"], input[type="month"],
    input[type="number"], input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    select{ cursor:pointer; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }

    .form{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .field{ grid-column: span 12; }
    @media (min-width: 720px){
      .field.half{ grid-column: span 6; }
      .field.third{ grid-column: span 4; }
    }
    .help{ font-size:12px; color:var(--muted); margin-top:6px; }

    .seg{
      display:flex; width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    .segBtn, .segBtnAlt{
      flex:1; padding:10px 10px; border:0; background: transparent;
      color:var(--text); cursor:pointer; font-weight:800; letter-spacing:.2px;
    }
    .segBtn.active, .segBtnAlt.active{
      background: linear-gradient(180deg, rgba(36,52,107,.65), rgba(26,38,80,.35));
    }

    .actions{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      flex-wrap:wrap; margin-top:4px;
    }
    .btn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      padding:11px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      transition: .12s transform ease, .12s border ease, .12s background ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      border-color: rgba(45,212,191,.35);
      background: linear-gradient(180deg, rgba(45,212,191,.25), rgba(45,212,191,.10));
    }
    .btn.danger{
      border-color: rgba(251,113,133,.35);
      background: linear-gradient(180deg, rgba(251,113,133,.22), rgba(251,113,133,.08));
    }

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background: rgba(27,39,80,.65);
      border:1px solid var(--line);
      font-size:12px; color:var(--text); font-weight:800;
    }
    .chip.good{ color: var(--good); }
    .chip.bad{ color: var(--bad); }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      padding:12px; border:1px solid var(--line); border-radius:14px; background: rgba(0,0,0,.18);
    }
    .itemLeft{ min-width:0; flex:1; }
    .itemMeta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:4px; }
    .itemTitle{
      font-weight:900; letter-spacing:.2px; margin-bottom:4px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .itemMemo{
      color:var(--muted); font-size:12px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .itemRight{
      text-align:right; display:flex; flex-direction:column; gap:8px;
      align-items:flex-end; min-width: 120px;
    }
    .amount{ font-size:16px; font-weight:950; letter-spacing:.2px; }
    .miniActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .miniBtn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .miniBtn.danger{ border-color: rgba(251,113,133,.35); }

    .empty{
      text-align:center; color:var(--muted); padding:26px 10px;
      border:1px dashed var(--line); border-radius:16px; background: rgba(0,0,0,.10);
    }

    .barList{ display:flex; flex-direction:column; gap:10px; }
    .barRow{ display:grid; grid-template-columns: 1fr 90px; gap:10px; align-items:center; }
    .barLabel{
      display:flex; justify-content:space-between; gap:10px;
      font-size:12px; color:var(--muted); margin-bottom:6px;
    }
    .barTrack{
      height:10px; border-radius:999px; background: rgba(255,255,255,.08);
      overflow:hidden; border:1px solid var(--line);
    }
    .barFill{
      height:100%; width:0%; border-radius:999px;
      background: linear-gradient(90deg, rgba(251,113,133,.75), rgba(45,212,191,.75));
    }
    .barAmt{ text-align:right; font-weight:900; font-size:12px; color:var(--text); white-space:nowrap; }

    .toast{
      position:fixed; left:50%; bottom:18px; transform: translateX(-50%);
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background: rgba(10, 14, 30, .88); box-shadow: var(--shadow);
      color:var(--text); font-weight:800; font-size:12px;
      opacity:0; pointer-events:none;
      transition: .18s opacity ease, .18s transform ease;
      z-index:9998;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-2px); }
  </style>
</head>

<body>
  <header class="appHeader">
    <div class="headerInner">
      <nav class="navTabs" aria-label="페이지 이동">
        <button class="navBtn active" type="button" data-page="dashboard">요약</button>
        <button class="navBtn" type="button" data-page="add">추가</button>
        <button class="navBtn" type="button" data-page="history">내역</button>
        <button class="navBtn" type="button" data-page="settings">설정</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- 요약 -->
    <section id="dashboard" class="page active">
      <div class="grid">
        <div class="card">
          <div class="cardTitle">
            <h2>이번 달 요약</h2>
            <div class="row">
              <label class="muted" for="dashMonth" style="margin:0;">월 선택</label>
              <input id="dashMonth" type="month" style="width:auto; min-width:160px;" />
            </div>
          </div>

          <div class="statGrid">
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">수입</div>
              <div id="dashIncome" class="statValue good">0원</div>
            </div>
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">지출</div>
              <div id="dashExpense" class="statValue bad">0원</div>
            </div>
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">잔액</div>
              <div id="dashBalance" class="statValue">0원</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardTitle">
            <h2>일별 요약</h2>
            <div class="row">
              <label class="muted" for="dailyDate" style="margin:0;">날짜</label>
              <input id="dailyDate" type="date" style="width:auto; min-width:180px;" />
              <span id="dailyDatePretty" class="muted" style="font-size:12px;"></span>
            </div>
          </div>

          <div class="statGrid">
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">수입</div>
              <div id="dayIncome" class="statValue good">0원</div>
            </div>
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">지출</div>
              <div id="dayExpense" class="statValue bad">0원</div>
            </div>
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">잔액</div>
              <div id="dayBalance" class="statValue">0원</div>
            </div>
          </div>
        </div>

        <!-- ✅ 요약 > 주별 요약(주차 표시 적용) -->
        <div class="card">
          <div class="cardTitle">
            <h2>주별 요약</h2>
            <div class="row">
              <label class="muted" for="weeklyDate" style="margin:0;">날짜</label>
              <select id="weeklyDate" style="width:auto; min-width:260px;"></select>
              <span id="weeklyDatePretty" class="muted" style="font-size:12px;"></span>
            </div>
          </div>

          <div class="statGrid">
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">수입</div>
              <div id="weekIncome" class="statValue good">0원</div>
            </div>
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">지출</div>
              <div id="weekExpense" class="statValue bad">0원</div>
            </div>
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">잔액</div>
              <div id="weekBalance" class="statValue">0원</div>
            </div>
          </div>
        </div>

        <div class="card half">
          <div class="cardTitle">
            <h2>지출 상위 카테고리</h2>
            <div class="muted" style="font-size:12px;">선택한 월 기준 (금액 / %)</div>
          </div>
          <div id="topExpenseCats" class="barList"></div>
        </div>

        <div class="card half">
          <div class="cardTitle">
            <h2>수입 상위 카테고리</h2>
            <div class="muted" style="font-size:12px;">선택한 월 기준 (금액 / %)</div>
          </div>
          <div id="topIncomeCats" class="barList"></div>
        </div>
      </div>
    </section>

    <!-- 추가 -->
    <section id="add" class="page">
      <div class="grid">
        <div class="card">
          <div class="cardTitle">
            <h2>내역 추가 / 수정</h2>
            <div class="muted" style="font-size:12px;">저장은 이 기기(브라우저)에만 남아</div>
          </div>

          <form id="entryForm" class="form" autocomplete="off">
            <input type="hidden" id="editingId" value="" />
            <input type="hidden" id="type" value="expense" />

            <div class="field half">
              <label for="date">날짜</label>
              <input id="date" type="date" required />
            </div>

            <div class="field half">
              <label>구분</label>
              <div class="seg" role="tablist" aria-label="수입/지출 선택">
                <button class="segBtn active" type="button" data-type="expense">지출</button>
                <button class="segBtn" type="button" data-type="income">수입</button>
              </div>
              <div class="help">지출은 빨강, 수입은 초록</div>
            </div>

            <div class="field half">
              <label for="category">카테고리</label>
              <select id="category" required></select>
              <input id="categoryCustom" type="text" placeholder="카테고리 직접 입력" style="margin-top:10px; display:none;" />
            </div>

            <div class="field half">
              <label for="amount">금액</label>
              <input id="amount" type="number" inputmode="numeric" min="1" step="1" placeholder="예: 12000" required />
              <div class="help">1원 이상 입력</div>
            </div>

            <div class="field">
              <label for="memo">메모(선택)</label>
              <input id="memo" type="text" maxlength="60" placeholder="예: 점심, 버스, 월급…" />
            </div>

            <div class="field">
              <div class="actions">
                <button id="submitBtn" class="btn primary" type="submit">저장</button>
                <button id="cancelEditBtn" class="btn" type="button" style="display:none;">수정 취소</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- 내역 -->
    <section id="history" class="page">
      <div class="grid">
        <div class="card">
          <div class="cardTitle"><h2>내역</h2></div>

          <div id="historyFilters" class="card" style="background: rgba(0,0,0,.14); box-shadow:none; margin-bottom:12px;">
            <div class="form" style="gap:10px;">
              <div class="field">
                <label>기간</label>
                <div class="seg" role="tablist" aria-label="기간 선택">
                  <button class="segBtnAlt" type="button" data-period="day">일</button>
                  <button class="segBtnAlt" type="button" data-period="week">주</button>
                  <button class="segBtnAlt active" type="button" data-period="month">월</button>
                  <button class="segBtnAlt" type="button" data-period="year">년도</button>
                </div>
                <input type="hidden" id="historyPeriod" value="month" />
              </div>

              <div class="field half" id="wrapHistoryDay" style="display:none;">
                <label for="historyDay">일 선택</label>
                <input id="historyDay" type="date" />
              </div>

              <!-- ✅ 내역 주 선택: 월 + 주차(입력/선택) -->
              <div class="field" id="wrapHistoryWeek" style="display:none;">
                <label>주 선택</label>
                <div class="row" style="gap:10px;">
                  <input id="historyWeekMonth" type="month" style="flex:1; min-width:180px;" />
                  <input id="historyWeekNo" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2" placeholder="주차(예: 2)" style="width:140px;" />
                  <button class="btn" type="button" id="openWeekPicker">선택</button>
                </div>
                <div class="help">해당 월 기준 주차(일~토, 7일). 예: 1~7=1주차, 8~14=2주차… (단, 1일이 일요일이 아닌 달은 첫 일요일부터 1주차)</div>
              </div>

              <div class="field half" id="wrapHistoryMonth">
                <label for="historyMonth">월 선택</label>
                <input id="historyMonth" type="month" />
              </div>

              <div class="field half" id="wrapHistoryYear" style="display:none;">
                <label for="historyYear">년도 선택</label>
                <input id="historyYear" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="예: 2026" />
                <div class="help">직접 입력(4자리) 또는 클릭해서 선택</div>
              </div>

              <div class="field">
                <label>구분</label>
                <div class="seg" role="tablist" aria-label="지출/수입 선택">
                  <button class="segBtnAlt active" type="button" data-histtype="expense">지출</button>
                  <button class="segBtnAlt" type="button" data-histtype="income">수입</button>
                </div>
                <input type="hidden" id="historyType" value="expense" />
              </div>

              <div class="field">
                <label for="historyQuery">카테고리/메모</label>
                <input id="historyQuery" type="text" placeholder="카테고리/메모 검색" list="historyCategoryList" />
                <datalist id="historyCategoryList"></datalist>
              </div>
            </div>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <div class="chip" id="historyCount">0건</div>
            <div class="chip bad" id="historySumExpense">지출 0원</div>
            <div class="chip good" id="historySumIncome">수입 0원</div>
            <div class="spacer"></div>
            <button class="btn" type="button" id="quickToAdd">+ 추가로 이동</button>
          </div>

          <div id="historyList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- 설정 -->
    <section id="settings" class="page">
      <div class="grid">
        <div class="card">
          <div class="cardTitle">
            <h2>백업 / 복원</h2>
            <div class="muted" style="font-size:12px;">JSON/CSV/XLSX 내보내기 + JSON 가져오기</div>
          </div>

          <div class="row" style="gap:10px; margin-bottom:12px;">
            <button class="btn primary" type="button" id="exportJson">JSON 내보내기</button>
            <button class="btn" type="button" id="exportCsv">CSV 내보내기</button>
            <button class="btn" type="button" id="exportXlsx">엑셀(xlsx) 내보내기</button>
          </div>

          <div class="card" style="background: rgba(0,0,0,.14); box-shadow:none;">
            <div class="muted" style="font-size:12px; margin-bottom:10px;">
              JSON 파일 가져오기: 파일 선택 후 합치기/덮어쓰기 선택
            </div>
            <div class="row" style="gap:10px;">
              <input id="importFile" type="file" accept=".json,application/json" />
              <button class="btn" type="button" id="importBtn">가져오기</button>
            </div>
          </div>

          <div class="card" style="background: rgba(0,0,0,.14); box-shadow:none; margin-top:12px;">
            <div class="muted" style="font-size:12px; margin-bottom:10px;">
              JSON 텍스트 붙여넣기 복원: 백업 텍스트를 붙여넣고 복원
            </div>
            <textarea id="importText" placeholder="여기에 JSON 텍스트 붙여넣기" style="height:160px;"></textarea>
            <div class="actions" style="margin-top:10px;">
              <button class="btn" type="button" id="importTextBtn">붙여넣기 복원</button>
            </div>
          </div>

          <div class="card" style="background: rgba(0,0,0,.14); box-shadow:none; margin-top:12px;">
            <div class="row">
              <div>
                <div style="font-weight:900;">전체 삭제</div>
                <div class="muted" style="font-size:12px;">이 기기에 저장된 내역이 모두 삭제됨</div>
              </div>
              <div class="spacer"></div>
              <button class="btn danger" type="button" id="clearAll">전체 삭제</button>
            </div>
          </div>

          <div class="help" style="margin-top:12px;">
            참고: 이 앱은 <b>localStorage</b>에 저장돼. 같은 브라우저/기기에서만 유지되고,
            브라우저 데이터 삭제 시 사라질 수 있어.
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- 백업 모달 -->
  <div id="backupModal" style="
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; padding:14px; z-index:9999;">
    <div style="width:min(900px, 100%); background:rgba(10,14,30,.96);
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.45);">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
        <div style="font-weight:900;">백업 텍스트</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" id="backupCopyBtn" class="btn">복사</button>
          <button type="button" id="backupCloseBtn" class="btn danger">닫기</button>
        </div>
      </div>
      <div class="muted" style="font-size:12px; margin:8px 0 10px;">
        공유/다운로드가 막힌 환경이면 아래 내용을 복사해서 메모앱 등에 저장해.
      </div>
      <textarea id="backupText" style="width:100%; height:52vh;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></textarea>
    </div>
  </div>

  <!-- ✅ 연도 선택 모달 -->
  <div id="yearModal" style="
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; padding:14px; z-index:9997;">
    <div style="width:min(520px, 100%); background:rgba(10,14,30,.96);
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.45);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:900;">연도 선택</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" id="yearPrev" class="btn">◀</button>
          <button type="button" id="yearNext" class="btn">▶</button>
          <button type="button" id="yearClose" class="btn danger">닫기</button>
        </div>
      </div>
      <div id="yearRangeLabel" class="muted" style="font-size:12px; margin:10px 0;"></div>
      <div id="yearGrid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;"></div>
    </div>
  </div>

  <!-- ✅ 내역 주차 선택 모달 -->
  <div id="weekModal" style="
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; padding:14px; z-index:9996;">
    <div style="width:min(520px, 100%); background:rgba(10,14,30,.96);
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.45);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:900;">주차 선택</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" id="weekClose" class="btn danger">닫기</button>
        </div>
      </div>
      <div id="weekRangeLabel" class="muted" style="font-size:12px; margin:10px 0;"></div>
      <div id="weekGrid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;"></div>
    </div>
  </div>

  <script>
    (() => {
      "use strict";

      // 오프라인(Service Worker)
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
      }

      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      const STORAGE_KEY = "ledger_entries_v1";
      const CLAMP_WEEK_TO_MONTH = true;

      const CATEGORIES = {
        expense: ["식비", "교통", "주거/통신", "생활", "의료", "문화", "교육", "쇼핑", "여행", "기타", "직접입력"],
        income: ["급여", "용돈", "부수입", "환급", "기타", "직접입력"],
      };

      const DOW_KO = ["일", "월", "화", "수", "목", "금", "토"];
      const moneyFmt = new Intl.NumberFormat("ko-KR");
      const money = (n) => `${moneyFmt.format(Math.round(n || 0))}원`;

      const todayISO = () => {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      };

      const monthISO = (dateStr) => (dateStr || "").slice(0, 7);
      const uid = () => (Date.now().toString(36) + Math.random().toString(36).slice(2, 9));

      function ymdFromDate(d) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function parseYMD(ymd) {
        const [y, m, d] = (ymd || "").split("-").map((x) => Number(x));
        if (!y || !m || !d) return null;
        return new Date(y, m - 1, d);
      }

      function prettyYmdKo(ymd) {
        const dt = parseYMD(ymd);
        if (!dt) return "";
        const y = dt.getFullYear();
        const m = dt.getMonth() + 1;
        const d = dt.getDate();
        const dow = DOW_KO[dt.getDay()];
        return `${y}년 ${m}월 ${d}일 (${dow})`;
      }

      // ========= 기존(내역 week input용 ISO 주) 유틸은 그대로 두되, 요약/내역 주차는 별도 규칙 적용 =========

      // ✅ (요약/내역 주차 공통 규칙) "월 내 주차" 계산: 주는 일요일 시작, 7일 단위
      // - 그 달의 1일이 일요일이면: 1~7 = 1주차, 8~14 = 2주차 ...
      // - 그 달의 1일이 일요일이 아니면: 그 달의 첫 일요일부터 1주차 시작
      //   (첫 일요일 이전 날짜는 주차 미인정(null))
      function weekOfMonthSundayStart(ymd) {
        const dt = parseYMD(ymd);
        if (!dt) return null;

        const y = dt.getFullYear();
        const m = dt.getMonth(); // 0-based
        const d = dt.getDate();

        const first = new Date(y, m, 1);
        const firstDow = first.getDay(); // 0=일..6=토

        if (firstDow === 0) {
          return Math.floor((d - 1) / 7) + 1;
        }

        const firstSundayDay = 1 + (7 - firstDow); // 1..7
        if (d < firstSundayDay) return null;
        return Math.floor((d - firstSundayDay) / 7) + 1;
      }

      // ✅ (요약 주별요약 전용) 주차 미인정(null) 구간은 "숨김": 빈 배열 반환
      function weekDatesForDashboard(ymd) {
        const dt = parseYMD(ymd);
        if (!dt) return [];

        const y = dt.getFullYear();
        const m = dt.getMonth(); // 0-based
        const d = dt.getDate();

        const first = new Date(y, m, 1);
        const firstDow = first.getDay(); // 0=일..6=토
        const lastDay = new Date(y, m + 1, 0).getDate();

        const weekNo = weekOfMonthSundayStart(ymd);
        if (weekNo === null) return []; // ✅ 숨김

        let startDay;
        if (firstDow === 0) startDay = 1 + (weekNo - 1) * 7;
        else {
          const firstSundayDay = 1 + (7 - firstDow);
          startDay = firstSundayDay + (weekNo - 1) * 7;
        }

        const endDay = Math.min(lastDay, startDay + 6);
        const out = [];
        for (let day = startDay; day <= endDay; day++) out.push(ymdFromDate(new Date(y, m, day)));
        return out;
      }

      // ✅ (내역 주 선택 전용) 월 + 주차 → 기간(start/end) 계산
      function weekRangeForMonthWeek(monthStr, weekNo) {
        // monthStr: "YYYY-MM", weekNo: number >=1
        if (!monthStr || !/^\d{4}-\d{2}$/.test(monthStr)) return null;
        const n = Number(weekNo);
        if (!Number.isFinite(n) || n < 1) return null;

        const [Y, M] = monthStr.split("-").map(Number);
        const y = Y;
        const m = M - 1; // 0-based
        const first = new Date(y, m, 1);
        const firstDow = first.getDay();
        const lastDay = new Date(y, m + 1, 0).getDate();

        let startDay;
        if (firstDow === 0) {
          startDay = 1 + (n - 1) * 7;
        } else {
          const firstSundayDay = 1 + (7 - firstDow);
          startDay = firstSundayDay + (n - 1) * 7;
          // 주차 미인정 구간 자체가 없도록 설계(weekNo 1은 firstSundayDay부터)
        }

        if (startDay < 1 || startDay > lastDay) return null;
        const endDay = Math.min(lastDay, startDay + 6);

        const start = ymdFromDate(new Date(y, m, startDay));
        const end = ymdFromDate(new Date(y, m, endDay));
        return { start, end };
      }

      // ✅ (내역 주 선택 전용) 해당 월의 최대 주차 계산
      function maxWeekNoForMonth(monthStr) {
        if (!monthStr || !/^\d{4}-\d{2}$/.test(monthStr)) return 0;
        const [Y, M] = monthStr.split("-").map(Number);
        const y = Y;
        const m = M - 1;
        const first = new Date(y, m, 1);
        const firstDow = first.getDay();
        const lastDay = new Date(y, m + 1, 0).getDate();

        if (firstDow === 0) {
          return Math.ceil(lastDay / 7);
        } else {
          const firstSundayDay = 1 + (7 - firstDow);
          const remain = lastDay - firstSundayDay + 1;
          if (remain <= 0) return 0;
          return Math.ceil(remain / 7);
        }
      }

      function loadEntries() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch {
          return [];
        }
      }

      function saveEntries(entries) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      }

      let entries = loadEntries();
      entries.sort((a, b) => (b.date || "").localeCompare(a.date || "") || (b.createdAt || 0) - (a.createdAt || 0));

      function toast(msg) {
        const el = $("#toast");
        el.textContent = msg;
        el.classList.add("show");
        window.clearTimeout(toast._t);
        toast._t = window.setTimeout(() => el.classList.remove("show"), 1600);
      }

      function showBackupModal(text) {
        const wrap = $("#backupModal");
        const ta = $("#backupText");
        wrap.style.display = "flex";
        ta.value = text;
      }

      function wireBackupModal() {
        const wrap = $("#backupModal");
        $("#backupCloseBtn").onclick = () => (wrap.style.display = "none");
        $("#backupCopyBtn").onclick = async () => {
          const t = $("#backupText").value;
          try { await navigator.clipboard.writeText(t); toast("복사 완료"); }
          catch { toast("복사 실패: 길게 눌러 전체 선택 후 복사"); }
        };
      }

      // Share → Clipboard → 모달
      async function smartExport(filename, content, mime) {
        const blob = new Blob([content], { type: mime });
        const file = new File([blob], filename, { type: mime });

        try {
          if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
            await navigator.share({ files: [file], title: filename });
            return { ok: true, mode: "share" };
          }
        } catch {}

        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(content);
            return { ok: true, mode: "clipboard" };
          }
        } catch {}

        showBackupModal(content);
        return { ok: true, mode: "modal" };
      }

      // 페이지 전환
      function setPage(pageId) {
        $$(".navBtn").forEach((b) => b.classList.toggle("active", b.dataset.page === pageId));
        $$(".page").forEach((p) => p.classList.toggle("active", p.id === pageId));
      }
      $$(".navBtn").forEach((btn) => btn.addEventListener("click", () => setPage(btn.dataset.page)));

      // ---------- 폼(추가/수정) ----------
      const entryForm = $("#entryForm");
      const editingIdEl = $("#editingId");
      const typeEl = $("#type");
      const dateEl = $("#date");
      const categoryEl = $("#category");
      const categoryCustomEl = $("#categoryCustom");
      const amountEl = $("#amount");
      const memoEl = $("#memo");
      const submitBtn = $("#submitBtn");
      const cancelEditBtn = $("#cancelEditBtn");

      function setType(type) {
        typeEl.value = type;
        $$(`.segBtn[data-type]`).forEach((b) => b.classList.toggle("active", b.dataset.type === type));
        refreshCategoryOptions();
      }
      $$(`.segBtn[data-type]`).forEach((b) => b.addEventListener("click", () => setType(b.dataset.type)));

      function refreshCategoryOptions() {
        const type = typeEl.value;
        const options = CATEGORIES[type] || ["기타", "직접입력"];
        const current = categoryEl.value;

        categoryEl.innerHTML = options.map((c) => `<option value="${escapeHtmlAttr(c)}">${escapeHtml(c)}</option>`).join("");
        categoryEl.value = options.includes(current) ? current : options[0];
        handleCategoryCustom();
      }

      function handleCategoryCustom() {
        const isCustom = categoryEl.value === "직접입력";
        categoryCustomEl.style.display = isCustom ? "block" : "none";
        if (!isCustom) categoryCustomEl.value = "";
      }
      categoryEl.addEventListener("change", handleCategoryCustom);

      function startEdit(entry) {
        editingIdEl.value = entry.id;
        dateEl.value = entry.date;
        setType(entry.type);

        const list = CATEGORIES[entry.type] || [];
        if (list.includes(entry.category)) {
          categoryEl.value = entry.category;
          categoryCustomEl.value = "";
        } else {
          categoryEl.value = "직접입력";
          categoryCustomEl.value = entry.category || "";
        }
        handleCategoryCustom();

        amountEl.value = entry.amount;
        memoEl.value = entry.memo || "";

        submitBtn.textContent = "수정 저장";
        cancelEditBtn.style.display = "inline-block";
        setPage("add");
        toast("수정 모드");
      }

      function endEditMode() {
        editingIdEl.value = "";
        submitBtn.textContent = "저장";
        cancelEditBtn.style.display = "none";
      }

      cancelEditBtn.addEventListener("click", () => {
        endEditMode();
        entryForm.reset();
        dateEl.value = todayISO();
        setType("expense");
        refreshCategoryOptions();
        toast("수정 취소");
      });

      entryForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const type = typeEl.value;
        const date = dateEl.value || todayISO();

        let category = categoryEl.value;
        if (category === "직접입력") category = (categoryCustomEl.value || "").trim();

        const amount = Number(amountEl.value || 0);
        const memo = (memoEl.value || "").trim();

        if (!date) return toast("날짜를 입력해줘");
        if (!category) return toast("카테고리를 입력해줘");
        if (!Number.isFinite(amount) || amount < 1) return toast("금액은 1원 이상");

        const editingId = editingIdEl.value;

        if (editingId) {
          const idx = entries.findIndex((x) => x.id === editingId);
          if (idx >= 0) entries[idx] = { ...entries[idx], type, date, category, amount, memo };
          else entries.unshift({ id: uid(), type, date, category, amount, memo, createdAt: Date.now() });
          toast("수정 완료");
          endEditMode();
        } else {
          entries.unshift({ id: uid(), type, date, category, amount, memo, createdAt: Date.now() });
          toast("저장 완료");
        }

        entries.sort((a, b) => (b.date || "").localeCompare(a.date || "") || (b.createdAt || 0) - (a.createdAt || 0));
        saveEntries(entries);

        entryForm.reset();
        dateEl.value = todayISO();
        setType(type);
        refreshCategoryOptions();

        renderAll();
        setPage("history");
      });

      // ---------- 내역(필터/리스트) ----------
      const historyPeriodEl = $("#historyPeriod");
      const historyDayEl = $("#historyDay");
      const historyWeekMonthEl = $("#historyWeekMonth");
      const historyWeekNoEl = $("#historyWeekNo");
      const openWeekPickerBtn = $("#openWeekPicker");
      const historyMonthEl = $("#historyMonth");
      const historyYearEl = $("#historyYear");
      const historyTypeEl = $("#historyType");
      const historyQueryEl = $("#historyQuery");

      const wrapHistoryDay = $("#wrapHistoryDay");
      const wrapHistoryWeek = $("#wrapHistoryWeek");
      const wrapHistoryMonth = $("#wrapHistoryMonth");
      const wrapHistoryYear = $("#wrapHistoryYear");

      const historyListEl = $("#historyList");
      const historyCountEl = $("#historyCount");
      const historySumExpenseEl = $("#historySumExpense");
      const historySumIncomeEl = $("#historySumIncome");

      // ✅ 내역 카테고리 자동완성 목록
      const historyCategoryListEl = $("#historyCategoryList");
      function refreshHistoryCategoryDatalist() {
        if (!historyCategoryListEl) return;

        const type = historyTypeEl.value;
        const base = (CATEGORIES[type] || []).filter((c) => c !== "직접입력");

        const used = Array.from(new Set(
          entries
            .filter((e) => e && e.type === type)
            .map((e) => String(e.category || "").trim())
            .filter((c) => c && c !== "직접입력")
        ));

        const all = Array.from(new Set([...base, ...used])).sort((a, b) => a.localeCompare(b, "ko"));
        historyCategoryListEl.innerHTML = all.map((c) => `<option value="${escapeHtmlAttr(c)}"></option>`).join("");
      }

      function setHistoryPeriod(period) {
        historyPeriodEl.value = period;
        $$("#historyFilters button[data-period]").forEach((b) => b.classList.toggle("active", b.dataset.period === period));

        wrapHistoryDay.style.display = (period === "day") ? "block" : "none";
        wrapHistoryWeek.style.display = (period === "week") ? "block" : "none";
        wrapHistoryMonth.style.display = (period === "month") ? "block" : "none";
        wrapHistoryYear.style.display = (period === "year") ? "block" : "none";

        renderHistory();
      }

      function setHistoryType(type) {
        historyTypeEl.value = type;
        $$("#historyFilters button[data-histtype]").forEach((b) => b.classList.toggle("active", b.dataset.histtype === type));
        refreshHistoryCategoryDatalist();
        renderHistory();
      }

      $$("#historyFilters button[data-period]").forEach((btn) => btn.addEventListener("click", () => setHistoryPeriod(btn.dataset.period)));
      $$("#historyFilters button[data-histtype]").forEach((btn) => btn.addEventListener("click", () => setHistoryType(btn.dataset.histtype)));

      // ✅ 내역 "주차" 입력 정리(숫자만)
      function sanitizeWeekNoInput() {
        const digits = (historyWeekNoEl.value || "").replace(/\D/g, "").slice(0, 2);
        if (historyWeekNoEl.value !== digits) historyWeekNoEl.value = digits;
      }
      historyWeekNoEl.addEventListener("input", () => { sanitizeWeekNoInput(); renderHistory(); });
      historyWeekMonthEl.addEventListener("input", () => { renderHistory(); refreshWeekPickerGrid(); });

      // ✅ 내역 "년도" 입력 정리(숫자만)
      historyYearEl.addEventListener("input", () => {
        const digits = (historyYearEl.value || "").replace(/\D/g, "").slice(0, 4);
        if (historyYearEl.value !== digits) historyYearEl.value = digits;
        if (digits.length === 4) renderHistory();
      });

      // ---------- 내역 주차 선택 모달 ----------
      const weekModal = $("#weekModal");
      const weekGrid = $("#weekGrid");
      const weekClose = $("#weekClose");
      const weekRangeLabel = $("#weekRangeLabel");

      function openWeekModal() {
        refreshWeekPickerGrid();
        weekModal.style.display = "flex";
      }
      function closeWeekModal() {
        weekModal.style.display = "none";
      }
      weekClose.addEventListener("click", closeWeekModal);
      weekModal.addEventListener("click", (e) => { if (e.target === weekModal) closeWeekModal(); });
      openWeekPickerBtn.addEventListener("click", openWeekModal);

      function refreshWeekPickerGrid() {
        const m = historyWeekMonthEl.value || monthISO(todayISO());
        const maxW = maxWeekNoForMonth(m);

        weekRangeLabel.textContent = maxW > 0 ? `${m} (1~${maxW}주차)` : `${m} (주차 없음)`;

        weekGrid.innerHTML = "";
        for (let w = 1; w <= maxW; w++) {
          const r = weekRangeForMonthWeek(m, w);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn";
          btn.textContent = `${w}주차`;
          if (r) btn.title = `${r.start} ~ ${r.end}`;

          // 선택 강조
          const cur = Number((historyWeekNoEl.value || "").trim());
          if (Number.isFinite(cur) && cur === w) btn.classList.add("primary");

          btn.addEventListener("click", () => {
            historyWeekNoEl.value = String(w);
            closeWeekModal();
            renderHistory();
          });

          weekGrid.appendChild(btn);
        }
      }

      // ---------- 내역 필터 ----------
      function getFilteredEntriesHistory() {
        const period = historyPeriodEl.value; // day/week/month/year
        const type = historyTypeEl.value; // expense/income
        const q = (historyQueryEl.value || "").trim().toLowerCase();

        const dayVal = historyDayEl.value;
        const weekMonthVal = historyWeekMonthEl.value;  // YYYY-MM
        const weekNoVal = historyWeekNoEl.value;        // "2"
        const monthVal = historyMonthEl.value;
        const yearVal = String(historyYearEl.value || "").trim();

        let weekRange = null;
        if (period === "week") {
          sanitizeWeekNoInput();
          weekRange = weekRangeForMonthWeek(weekMonthVal, Number(weekNoVal));
        }

        return entries.filter((e) => {
          // 기간 필터
          if (period === "day") {
            if (!dayVal) return false;
            if (e.date !== dayVal) return false;
          } else if (period === "week") {
            if (!weekMonthVal || !weekRange) return false;
            // 주는 해당 월 안에서만 인정
            if (monthISO(e.date) !== weekMonthVal) return false;
            if (e.date < weekRange.start || e.date > weekRange.end) return false;
          } else if (period === "month") {
            if (!monthVal) return false;
            if (monthISO(e.date) !== monthVal) return false;
          } else if (period === "year") {
            if (!yearVal || yearVal.length !== 4) return false;
            if ((e.date || "").slice(0, 4) !== yearVal) return false;
          }

          // 구분
          if (e.type !== type) return false;

          // 검색
          if (q) {
            const hay = `${e.category || ""} ${e.memo || ""}`.toLowerCase();
            if (!hay.includes(q)) return false;
          }

          return true;
        });
      }

      function renderEntryItem(e) {
        const isExpense = e.type === "expense";
        const sign = isExpense ? "-" : "+";
        const amtClass = isExpense ? "bad" : "good";
        const chipClass = isExpense ? "bad" : "good";
        const memo = (e.memo || "").trim();

        return `
          <div class="item" data-id="${escapeHtmlAttr(e.id)}">
            <div class="itemLeft">
              <div class="itemMeta">
                <span class="chip ${chipClass}">${isExpense ? "지출" : "수입"}</span>
                <span class="chip">${escapeHtml(e.date)}</span>
                <span class="chip">${escapeHtml(e.category || "")}</span>
              </div>
              <div class="itemTitle">${escapeHtml(e.category || "")}</div>
              <div class="itemMemo">${memo ? escapeHtml(memo) : "<span class='muted'>메모 없음</span>"}</div>
            </div>

            <div class="itemRight">
              <div class="amount ${amtClass}">${sign}${moneyFmt.format(Math.round(e.amount || 0))}원</div>
              <div class="miniActions">
                <button class="miniBtn" type="button" data-action="edit">편집</button>
                <button class="miniBtn danger" type="button" data-action="delete">삭제</button>
              </div>
            </div>
          </div>
        `;
      }

      function renderHistory() {
        const list = getFilteredEntriesHistory();

        let sumExpense = 0;
        let sumIncome = 0;
        list.forEach((e) => {
          if (e.type === "expense") sumExpense += e.amount;
          else sumIncome += e.amount;
        });

        historyCountEl.textContent = `${list.length}건`;
        historySumExpenseEl.textContent = `지출 ${money(sumExpense)}`;
        historySumIncomeEl.textContent = `수입 ${money(sumIncome)}`;

        if (list.length === 0) {
          historyListEl.innerHTML = `<div class="empty">조건에 맞는 내역이 없어.<br/>기간/구분/검색을 바꿔줘.</div>`;
          return;
        }

        historyListEl.innerHTML = list.map(renderEntryItem).join("");
      }

      historyListEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;

        const item = e.target.closest(".item");
        if (!item) return;

        const id = item.getAttribute("data-id");
        const action = btn.getAttribute("data-action");

        const entry = entries.find((x) => x.id === id);
        if (!entry) return toast("대상을 찾을 수 없어");

        if (action === "delete") {
          if (!confirm("이 내역을 삭제할까?")) return;
          entries = entries.filter((x) => x.id !== id);
          saveEntries(entries);
          renderAll();
          toast("삭제 완료");
          return;
        }

        if (action === "edit") startEdit(entry);
      });

      [historyDayEl, historyMonthEl, historyQueryEl].forEach((el) => {
        el.addEventListener("input", () => renderHistory());
      });

      $("#quickToAdd").addEventListener("click", () => setPage("add"));

      // ---------- 대시보드 ----------
      const dashMonthEl = $("#dashMonth");
      const dashIncomeEl = $("#dashIncome");
      const dashExpenseEl = $("#dashExpense");
      const dashBalanceEl = $("#dashBalance");
      const topExpenseCatsEl = $("#topExpenseCats");
      const topIncomeCatsEl = $("#topIncomeCats");

      const dailyDateEl = $("#dailyDate");
      const dailyDatePrettyEl = $("#dailyDatePretty");
      const dayIncomeEl = $("#dayIncome");
      const dayExpenseEl = $("#dayExpense");
      const dayBalanceEl = $("#dayBalance");

      const weeklyDateEl = $("#weeklyDate");
      const weeklyDatePrettyEl = $("#weeklyDatePretty");
      const weekIncomeEl = $("#weekIncome");
      const weekExpenseEl = $("#weekExpense");
      const weekBalanceEl = $("#weekBalance");

      function sumByCategory(list) {
        const map = {};
        for (const e of list) {
          const k = (e.category || "기타").trim() || "기타";
          map[k] = (map[k] || 0) + (Number(e.amount) || 0);
        }
        return map;
      }

      function renderBars(container, map, totalAmount, emptyText) {
        const entriesArr = Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, 8);
        if (!totalAmount || totalAmount <= 0 || entriesArr.length === 0) {
          container.innerHTML = `<div class="empty">${escapeHtml(emptyText)}</div>`;
          return;
        }
        container.innerHTML = entriesArr.map(([name, val]) => {
          const pct = Math.max(0, Math.min(100, (val / totalAmount) * 100));
          return `
            <div class="barRow">
              <div>
                <div class="barLabel">
                  <span>${escapeHtml(name)}</span>
                  <span>${money(val)}</span>
                </div>
                <div class="barTrack">
                  <div class="barFill" style="width:${pct.toFixed(1)}%"></div>
                </div>
              </div>
              <div class="barAmt">${pct.toFixed(1)}%</div>
            </div>
          `;
        }).join("");
      }

      function renderDashboard() {
        const m = dashMonthEl.value;
        const month = m || monthISO(todayISO());
        const monthEntries = entries.filter((e) => monthISO(e.date) === month);

        let income = 0;
        let expense = 0;
        const incomeList = [];
        const expenseList = [];

        for (const e of monthEntries) {
          if (e.type === "expense") {
            expense += e.amount || 0;
            expenseList.push(e);
          } else {
            income += e.amount || 0;
            incomeList.push(e);
          }
        }

        const balance = income - expense;

        dashIncomeEl.textContent = money(income);
        dashExpenseEl.textContent = money(expense);
        dashBalanceEl.textContent = money(balance);
        dashBalanceEl.classList.toggle("good", balance > 0);
        dashBalanceEl.classList.toggle("bad", balance < 0);

        renderBars(topExpenseCatsEl, sumByCategory(expenseList), expense, "이번 달 지출 내역이 없어.");
        renderBars(topIncomeCatsEl, sumByCategory(incomeList), income, "이번 달 수입 내역이 없어.");
      }

      function initDailyDateOptions() {
        const base = dailyDateEl.value || todayISO();
        dailyDateEl.value = base;
        if (dailyDatePrettyEl) dailyDatePrettyEl.textContent = prettyYmdKo(base);
        syncWeeklyDatesFromDaily();
      }

      function renderDailySummary() {
        const selected = dailyDateEl.value || todayISO();
        if (dailyDateEl.value !== selected) dailyDateEl.value = selected;
        if (dailyDatePrettyEl) dailyDatePrettyEl.textContent = prettyYmdKo(selected);

        const dayEntries = entries.filter((e) => e.date === selected);

        let income = 0;
        let expense = 0;
        for (const e of dayEntries) {
          if (e.type === "expense") expense += e.amount || 0;
          else income += e.amount || 0;
        }
        const balance = income - expense;

        dayIncomeEl.textContent = money(income);
        dayExpenseEl.textContent = money(expense);
        dayBalanceEl.textContent = money(balance);
        dayBalanceEl.classList.toggle("good", balance > 0);
        dayBalanceEl.classList.toggle("bad", balance < 0);
      }

      // ✅ 요약 주별요약: 주차 미인정이면 드롭다운 숨김 + 0 처리
      function renderWeeklySummaryEmpty() {
        weekIncomeEl.textContent = money(0);
        weekExpenseEl.textContent = money(0);
        weekBalanceEl.textContent = money(0);
        weekBalanceEl.classList.remove("good", "bad");
      }

      function syncWeeklyDatesFromDaily() {
        if (!weeklyDateEl) return;

        const base = dailyDateEl.value || todayISO();
        const days = weekDatesForDashboard(base);

        // ✅ 첫 일요일 이전 날짜면 드롭다운 비우고 0 처리(숨김)
        if (!days || days.length === 0) {
          weeklyDateEl.innerHTML = "";
          if (weeklyDatePrettyEl) weeklyDatePrettyEl.textContent = "해당 월 1주차(첫 일요일) 전";
          renderWeeklySummaryEmpty();
          return;
        }

        weeklyDateEl.innerHTML = "";
        for (const ymd of days) {
          const wk = weekOfMonthSundayStart(ymd);
          const opt = document.createElement("option");
          opt.value = ymd;
          opt.textContent = wk ? `${prettyYmdKo(ymd)} · ${wk}주차` : prettyYmdKo(ymd);
          weeklyDateEl.appendChild(opt);
        }

        weeklyDateEl.value = days.includes(base) ? base : (days[0] || "");

        const wk = weekOfMonthSundayStart(weeklyDateEl.value);
        if (weeklyDatePrettyEl) weeklyDatePrettyEl.textContent = wk ? `${prettyYmdKo(weeklyDateEl.value)} · ${wk}주차` : prettyYmdKo(weeklyDateEl.value);

        renderWeeklySummary();
      }

      function renderWeeklySummary() {
        if (!weeklyDateEl || !weekIncomeEl || !weekExpenseEl || !weekBalanceEl) return;

        const selected = weeklyDateEl.value || (dailyDateEl ? dailyDateEl.value : "");
        const days = weekDatesForDashboard(selected);

        // 숨김 상태
        if (!days || days.length === 0) {
          renderWeeklySummaryEmpty();
          return;
        }

        const start = days[0];
        const end = days[days.length - 1];

        let income = 0;
        let expense = 0;

        for (const e of entries) {
          if (!e || !e.date) continue;
          if (e.date < start || e.date > end) continue;

          if (e.type === "expense") expense += e.amount || 0;
          else income += e.amount || 0;
        }

        const balance = income - expense;

        weekIncomeEl.textContent = money(income);
        weekExpenseEl.textContent = money(expense);
        weekBalanceEl.textContent = money(balance);
        weekBalanceEl.classList.toggle("good", balance > 0);
        weekBalanceEl.classList.toggle("bad", balance < 0);

        const wk = weekOfMonthSundayStart(selected);
        if (weeklyDatePrettyEl) weeklyDatePrettyEl.textContent = wk ? `${prettyYmdKo(selected)} · ${wk}주차` : prettyYmdKo(selected);
      }

      dailyDateEl.addEventListener("change", () => {
        renderDailySummary();
        syncWeeklyDatesFromDaily();
      });

      if (weeklyDateEl) {
        weeklyDateEl.addEventListener("change", () => {
          renderWeeklySummary();
        });
      }

      dashMonthEl.addEventListener("input", () => {
        historyMonthEl.value = dashMonthEl.value;
        renderAll();
      });

      // ---------- 설정(내보내기/가져오기/삭제) ----------
      $("#exportJson").addEventListener("click", async () => {
        const payload = JSON.stringify({ exportedAt: new Date().toISOString(), entries }, null, 2);
        const filename = `ledger-backup-${monthISO(todayISO())}-${Date.now()}.json`;
        const r = await smartExport(filename, payload, "application/json;charset=utf-8");
        toast(r.mode === "share" ? "JSON 공유로 내보냄" : r.mode === "clipboard" ? "JSON이 복사됨" : "JSON 백업 텍스트 열림");
      });

      // ✅ CSV: 다운로드 우선 + BOM + sep
      $("#exportCsv").addEventListener("click", async () => {
        const header = ["date", "type", "category", "amount", "memo"];
        const rows = entries.map((e) => [
          e.date || "",
          e.type || "",
          e.category || "",
          String(e.amount || 0),
          (e.memo || "").replace(/\r?\n/g, " "),
        ]);

        const csvBody = [header, ...rows].map((cols) => cols.map(csvCell).join(",")).join("\n");
        const csvWithBom = "\ufeff" + "sep=,\n" + csvBody;

        const filename = `ledger-${monthISO(todayISO())}-${Date.now()}.csv`;
        const blob = new Blob([csvWithBom], { type: "text/csv;charset=utf-8" });

        // 다운로드 우선
        try {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          a.rel = "noopener";
          a.style.display = "none";
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 2000);
          toast("CSV 다운로드 완료");
          return;
        } catch {}

        // 공유
        try {
          const file = new File([blob], filename, { type: "text/csv;charset=utf-8" });
          if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
            await navigator.share({ files: [file], title: filename });
            toast("CSV 공유로 내보냄");
            return;
          }
        } catch {}

        // 클립보드
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(csvWithBom);
            toast("CSV가 클립보드에 복사됨");
            return;
          }
        } catch {}

        showBackupModal(csvWithBom);
        toast("CSV 백업 텍스트 열림");
      });

      // ✅ XLSX 내보내기
      async function exportXlsxSmart() {
        if (!window.XLSX) {
          toast("xlsx 라이브러리를 못 찾았어. /xlsx.full.min.js 파일 확인해줘");
          return;
        }

        const data = entries.map((e) => ({
          날짜: e.date || "",
          구분: e.type === "expense" ? "지출" : "수입",
          카테고리: e.category || "",
          금액: Number(e.amount || 0),
          메모: e.memo || ""
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "가계부");

        const arrayBuffer = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([arrayBuffer], {
          type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        });

        const filename = `ledger-${monthISO(todayISO())}-${Date.now()}.xlsx`;

        try {
          const file = new File([blob], filename, { type: blob.type });
          if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
            await navigator.share({ files: [file], title: filename });
            toast("엑셀 파일 공유로 내보냄");
            return;
          }
        } catch {}

        try {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          a.rel = "noopener";
          a.style.display = "none";
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 2000);
          toast("엑셀 파일 다운로드 완료");
        } catch {
          toast("엑셀 저장이 막혔어. JSON 내보내기로 우회해줘");
        }
      }
      $("#exportXlsx").addEventListener("click", exportXlsxSmart);

      const importFileEl = $("#importFile");
      $("#importBtn").addEventListener("click", async () => {
        const file = importFileEl.files && importFileEl.files[0];
        if (!file) return toast("JSON 파일을 먼저 선택해줘");

        const text = await file.text();
        const r = parseAndCleanImportedJson(text);
        if (!r.ok) return toast(r.msg);

        applyImported(r.cleaned);
        importFileEl.value = "";
      });

      $("#importTextBtn").addEventListener("click", () => {
        const text = ($("#importText").value || "").trim();
        if (!text) return toast("붙여넣을 JSON 텍스트가 없어");

        const r = parseAndCleanImportedJson(text);
        if (!r.ok) return toast(r.msg);

        applyImported(r.cleaned);
        $("#importText").value = "";
      });

      function applyImported(cleaned) {
        const merge = confirm("가져온 데이터를 기존 내역에 합칠까?\n확인: 합치기\n취소: 덮어쓰기");
        if (merge) {
          const byId = new Map(entries.map((e) => [e.id, e]));
          for (const e of cleaned) {
            if (byId.has(e.id)) byId.set(uid(), { ...e, id: uid(), createdAt: Date.now() });
            else byId.set(e.id, e);
          }
          entries = Array.from(byId.values());
        } else {
          if (!confirm("정말로 기존 내역을 덮어쓸까?")) return;
          entries = cleaned;
        }

        entries.sort((a, b) => (b.date || "").localeCompare(a.date || "") || (b.createdAt || 0) - (a.createdAt || 0));
        saveEntries(entries);
        renderAll();
        toast("복원 완료");
      }

      function parseAndCleanImportedJson(text) {
        let data;
        try { data = JSON.parse(text); }
        catch { return { ok:false, msg:"JSON 형식이 아니야" }; }

        const arr = Array.isArray(data) ? data : (Array.isArray(data.entries) ? data.entries : null);
        if (!arr) return { ok:false, msg:"가져올 entries 배열을 찾지 못했어" };

        const cleaned = arr
          .filter((x) => x && typeof x === "object")
          .map((x) => ({
            id: String(x.id || uid()),
            date: String(x.date || ""),
            type: x.type === "income" ? "income" : "expense",
            category: String(x.category || "기타"),
            amount: Number(x.amount || 0),
            memo: String(x.memo || ""),
            createdAt: Number(x.createdAt || Date.now()),
          }))
          .filter((x) => x.date && Number.isFinite(x.amount) && x.amount >= 1);

        if (cleaned.length === 0) return { ok:false, msg:"유효 데이터가 없어(금액 1원 이상)" };
        return { ok:true, cleaned };
      }

      $("#clearAll").addEventListener("click", () => {
        if (!confirm("저장된 내역을 전부 삭제할까?")) return;
        entries = [];
        saveEntries(entries);
        renderAll();
        toast("전체 삭제 완료");
      });

      // ---------- 유틸 ----------
      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function escapeHtmlAttr(str) {
        return escapeHtml(str).replaceAll("`", "&#096;");
      }
      function csvCell(v) {
        const s = String(v ?? "");
        const escaped = s.replaceAll('"', '""');
        return `"${escaped}"`;
      }

      // ---------- 초기값/렌더 ----------
      function init() {
        wireBackupModal();

        const today = todayISO();
        dateEl.value = today;

        const m = monthISO(today);
        dashMonthEl.value = m;

        historyMonthEl.value = m;
        historyDayEl.value = today;
        historyYearEl.value = String(new Date().getFullYear());

        // 내역 주 기본: 현재 월, 현재 주차(미인정이면 1)
        historyWeekMonthEl.value = m;
        const wkToday = weekOfMonthSundayStart(today);
        historyWeekNoEl.value = wkToday ? String(wkToday) : "1";

        setType("expense");
        refreshCategoryOptions();
        refreshHistoryCategoryDatalist();

        initDailyDateOptions(); // 요약 주차 드롭다운도 여기서 셋업

        setHistoryPeriod("month");
        setHistoryType("expense");

        renderAll();
      }

      function renderAll() {
        renderDashboard();
        renderDailySummary();
        syncWeeklyDatesFromDaily();
        renderHistory();
        refreshHistoryCategoryDatalist();
      }

      init();
    })();
  </script>
</body>
</html>
