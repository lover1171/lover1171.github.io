<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <title>오프라인 가계부 앱</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --panel2:#0f1630;
      --text:#e9ecf5;
      --muted:#aab2d5;
      --line:rgba(255,255,255,.10);
      --good:#2dd4bf;
      --bad:#fb7185;
      --warn:#fbbf24;
      --chip:#1b2750;
      --btn:#1a2650;
      --btn2:#24346b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, #182357 0%, var(--bg) 55%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", Arial, sans-serif;
      line-height:1.4;
    }

    a{ color:inherit; }

    .appHeader{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(10, 14, 30, .72);
      border-bottom:1px solid var(--line);
    }

    .headerInner{
      max-width:1100px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 220px;
    }
    .brandTitle{
      font-weight:800;
      letter-spacing:.2px;
      font-size:16px;
    }
    .brandSub{
      color:var(--muted);
      font-size:12px;
    }

    .navTabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .navBtn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      transition: .12s transform ease, .12s background ease, .12s border ease;
      white-space:nowrap;
    }
    .navBtn:hover{ transform: translateY(-1px); }
    .navBtn.active{
      background: linear-gradient(180deg, rgba(45,212,191,.25), rgba(45,212,191,.08));
      border-color: rgba(45,212,191,.35);
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding:18px 14px 40px;
    }

    .page{ display:none; }
    .page.active{ display:block; }

    /* ---- 아래부터 추가 스타일(통합본) ---- */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .card{
      grid-column: span 12;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .cardTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .cardTitle h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .muted{ color:var(--muted); }

    .statGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .stat{
      grid-column: span 12;
      padding:14px;
    }
    @media (min-width: 720px){
      .stat{ grid-column: span 4; }
      .card.half{ grid-column: span 6; }
    }
    .statLabel{
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
    }
    .statValue{
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .good{ color:var(--good); }
    .bad{ color:var(--bad); }
    .warn{ color:var(--warn); }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .spacer{ flex:1; }

    .input, select, textarea, input[type="date"], input[type="month"], input[type="number"], input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    select{ cursor:pointer; }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    .form{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .field{ grid-column: span 12; }
    @media (min-width: 720px){
      .field.half{ grid-column: span 6; }
    }
    .help{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }

    .seg{
      display:flex;
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    .segBtn{
      flex:1;
      padding:10px 10px;
      border:0;
      background: transparent;
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
    }
    .segBtn.active{
      background: linear-gradient(180deg, rgba(36,52,107,.65), rgba(26,38,80,.35));
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .btn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      padding:11px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      transition: .12s transform ease, .12s border ease, .12s background ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      border-color: rgba(45,212,191,.35);
      background: linear-gradient(180deg, rgba(45,212,191,.25), rgba(45,212,191,.10));
    }
    .btn.danger{
      border-color: rgba(251,113,133,.35);
      background: linear-gradient(180deg, rgba(251,113,133,.22), rgba(251,113,133,.08));
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(0,0,0,.18);
    }
    .itemLeft{
      min-width:0;
      flex:1;
    }
    .itemMeta{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:4px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(27,39,80,.65);
      border:1px solid var(--line);
      font-size:12px;
      color:var(--text);
      font-weight:800;
    }
    .chip.good{ color: var(--good); }
    .chip.bad{ color: var(--bad); }
    .itemTitle{
      font-weight:900;
      letter-spacing:.2px;
      margin-bottom:4px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .itemMemo{
      color:var(--muted);
      font-size:12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .itemRight{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      min-width: 120px;
    }
    .amount{
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .miniActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .miniBtn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .miniBtn.danger{
      border-color: rgba(251,113,133,.35);
    }

    .empty{
      text-align:center;
      color:var(--muted);
      padding:26px 10px;
      border:1px dashed var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.10);
    }

    .barList{ display:flex; flex-direction:column; gap:10px; }
    .barRow{ display:grid; grid-template-columns: 1fr 90px; gap:10px; align-items:center; }
    .barLabel{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .barTrack{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid var(--line);
    }
    .barFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(251,113,133,.75), rgba(45,212,191,.75));
    }
    .barAmt{
      text-align:right;
      font-weight:900;
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(10, 14, 30, .88);
      box-shadow: var(--shadow);
      color:var(--text);
      font-weight:800;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: .18s opacity ease, .18s transform ease;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }
  </style>
</head>

<body>
  <header class="appHeader">
    <div class="headerInner">
      <div class="brand">
        <div class="brandTitle">오프라인 가계부</div>
        <div class="brandSub">브라우저 로컬 저장 · 인터넷 없이 사용</div>
      </div>

      <nav class="navTabs" aria-label="페이지 이동">
        <button class="navBtn active" type="button" data-page="dashboard">요약</button>
        <button class="navBtn" type="button" data-page="add">추가</button>
        <button class="navBtn" type="button" data-page="history">내역</button>
        <button class="navBtn" type="button" data-page="settings">설정</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- 요약 -->
    <section id="dashboard" class="page active">
      <div class="grid">
        <div class="card">
          <div class="cardTitle">
            <h2>이번 달 요약</h2>
            <div class="row">
              <label class="muted" for="dashMonth" style="margin:0;">월 선택</label>
              <input id="dashMonth" type="month" style="width:auto; min-width:160px;" />
            </div>
          </div>

          <div class="statGrid">
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">수입</div>
              <div id="dashIncome" class="statValue good">0원</div>
            </div>
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">지출</div>
              <div id="dashExpense" class="statValue bad">0원</div>
            </div>
            <div class="card stat" style="background: rgba(0,0,0,.14); box-shadow:none;">
              <div class="statLabel">잔액</div>
              <div id="dashBalance" class="statValue">0원</div>
            </div>
          </div>
        </div>

        <div class="card half">
          <div class="cardTitle">
            <h2>지출 상위 카테고리</h2>
            <div class="muted" style="font-size:12px;">선택한 월 기준</div>
          </div>
          <div id="topExpenseCats" class="barList"></div>
        </div>

        <div class="card half">
          <div class="cardTitle">
            <h2>수입 상위 카테고리</h2>
            <div class="muted" style="font-size:12px;">선택한 월 기준</div>
          </div>
          <div id="topIncomeCats" class="barList"></div>
        </div>
      </div>
    </section>

    <!-- 추가 -->
    <section id="add" class="page">
      <div class="grid">
        <div class="card">
          <div class="cardTitle">
            <h2>내역 추가 / 수정</h2>
            <div class="muted" style="font-size:12px;">저장은 이 기기 브라우저에만 남아</div>
          </div>

          <form id="entryForm" class="form" autocomplete="off">
            <input type="hidden" id="editingId" value="" />
            <input type="hidden" id="type" value="expense" />

            <div class="field half">
              <label for="date">날짜</label>
              <input id="date" type="date" required />
            </div>

            <div class="field half">
              <label>구분</label>
              <div class="seg" role="tablist" aria-label="수입/지출 선택">
                <button class="segBtn active" type="button" data-type="expense">지출</button>
                <button class="segBtn" type="button" data-type="income">수입</button>
              </div>
              <div class="help">지출은 빨강, 수입은 초록으로 표시돼</div>
            </div>

            <div class="field half">
              <label for="category">카테고리</label>
              <select id="category" required></select>
              <input id="categoryCustom" type="text" placeholder="카테고리 직접 입력" style="margin-top:10px; display:none;" />
            </div>

            <div class="field half">
              <label for="amount">금액</label>
              <input id="amount" type="number" inputmode="numeric" min="0" step="100" placeholder="예: 12000" required />
              <div class="help">숫자만 입력(원 단위)</div>
            </div>

            <div class="field">
              <label for="memo">메모(선택)</label>
              <input id="memo" type="text" maxlength="60" placeholder="예: 점심, 버스, 월급…" />
            </div>

            <div class="field">
              <div class="actions">
                <button id="submitBtn" class="btn primary" type="submit">저장</button>
                <button id="cancelEditBtn" class="btn" type="button" style="display:none;">수정 취소</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- 내역 -->
    <section id="history" class="page">
      <div class="grid">
        <div class="card">
          <div class="cardTitle">
            <h2>내역</h2>
            <div class="row">
              <label class="muted" for="historyMonth" style="margin:0;">월</label>
              <input id="historyMonth" type="month" style="width:auto; min-width:160px;" />
              <select id="historyType" style="width:auto; min-width:120px;">
                <option value="all">전체</option>
                <option value="expense">지출</option>
                <option value="income">수입</option>
              </select>
              <input id="historyQuery" type="text" placeholder="카테고리/메모 검색" style="width:220px; max-width: 100%;" />
            </div>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <div class="chip" id="historyCount">0건</div>
            <div class="chip bad" id="historySumExpense">지출 0원</div>
            <div class="chip good" id="historySumIncome">수입 0원</div>
            <div class="spacer"></div>
            <button class="btn" type="button" id="quickToAdd">+ 추가로 이동</button>
          </div>

          <div id="historyList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- 설정 -->
    <section id="settings" class="page">
      <div class="grid">
        <div class="card">
          <div class="cardTitle">
            <h2>백업 / 복원</h2>
            <div class="muted" style="font-size:12px;">JSON/CSV로 내보내고 가져오기</div>
          </div>

          <div class="row" style="gap:10px; margin-bottom:12px;">
            <button class="btn primary" type="button" id="exportJson">JSON 내보내기</button>
            <button class="btn" type="button" id="exportCsv">CSV 내보내기</button>
          </div>

          <div class="card" style="background: rgba(0,0,0,.14); box-shadow:none;">
            <div class="muted" style="font-size:12px; margin-bottom:10px;">
              JSON 가져오기: 내보낸 파일을 선택하면 합치기/덮어쓰기 중 선택할 수 있어.
            </div>
            <div class="row" style="gap:10px;">
              <input id="importFile" type="file" accept=".json,application/json" />
              <button class="btn" type="button" id="importBtn">가져오기</button>
            </div>
          </div>

          <div class="card" style="background: rgba(0,0,0,.14); box-shadow:none; margin-top:12px;">
            <div class="row">
              <div>
                <div style="font-weight:900;">전체 삭제</div>
                <div class="muted" style="font-size:12px;">이 기기의 저장된 내역이 모두 삭제돼</div>
              </div>
              <div class="spacer"></div>
              <button class="btn danger" type="button" id="clearAll">전체 삭제</button>
            </div>
          </div>

          <div class="help" style="margin-top:12px;">
            참고: 이 앱은 <b>localStorage</b>에 저장돼. 같은 브라우저/기기에서만 유지되고,
            시크릿 모드나 브라우저 데이터 삭제 시 사라질 수 있어.
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    (() => {
      "use strict";

      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      const STORAGE_KEY = "ledger_entries_v1";

      const CATEGORIES = {
        expense: ["식비", "교통", "주거/통신", "생활", "의료", "문화", "교육", "쇼핑", "여행", "기타", "직접입력"],
        income: ["급여", "용돈", "부수입", "환급", "기타", "직접입력"],
      };

      const moneyFmt = new Intl.NumberFormat("ko-KR");
      const money = (n) => `${moneyFmt.format(Math.round(n || 0))}원`;

      const todayISO = () => {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      };

      const monthISO = (dateStr) => (dateStr || "").slice(0, 7); // YYYY-MM

      const uid = () => (Date.now().toString(36) + Math.random().toString(36).slice(2, 9));

      function loadEntries() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch {
          return [];
        }
      }

      function saveEntries(entries) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      }

      let entries = loadEntries();
      entries.sort((a, b) => (b.date || "").localeCompare(a.date || "") || (b.createdAt || 0) - (a.createdAt || 0));

      function toast(msg) {
        const el = $("#toast");
        el.textContent = msg;
        el.classList.add("show");
        window.clearTimeout(toast._t);
        toast._t = window.setTimeout(() => el.classList.remove("show"), 1600);
      }

      // ---------- 페이지 전환 ----------
      function setPage(pageId) {
        $$(".navBtn").forEach((b) => b.classList.toggle("active", b.dataset.page === pageId));
        $$(".page").forEach((p) => p.classList.toggle("active", p.id === pageId));
      }

      $$(".navBtn").forEach((btn) => {
        btn.addEventListener("click", () => setPage(btn.dataset.page));
      });

      // ---------- 폼(추가/수정) ----------
      const entryForm = $("#entryForm");
      const editingIdEl = $("#editingId");
      const typeEl = $("#type");
      const dateEl = $("#date");
      const categoryEl = $("#category");
      const categoryCustomEl = $("#categoryCustom");
      const amountEl = $("#amount");
      const memoEl = $("#memo");
      const submitBtn = $("#submitBtn");
      const cancelEditBtn = $("#cancelEditBtn");

      function setType(type) {
        typeEl.value = type;
        $$(".segBtn").forEach((b) => b.classList.toggle("active", b.dataset.type === type));
        refreshCategoryOptions();
      }

      $$(".segBtn").forEach((b) => {
        b.addEventListener("click", () => setType(b.dataset.type));
      });

      function refreshCategoryOptions() {
        const type = typeEl.value;
        const options = CATEGORIES[type] || ["기타", "직접입력"];

        const current = categoryEl.value;
        categoryEl.innerHTML = options.map((c) => `<option value="${escapeHtmlAttr(c)}">${escapeHtml(c)}</option>`).join("");

        // 기존 값이 options에 있으면 유지, 없으면 첫 값
        const has = options.includes(current);
        categoryEl.value = has ? current : options[0];

        handleCategoryCustom();
      }

      function handleCategoryCustom() {
        const isCustom = categoryEl.value === "직접입력";
        categoryCustomEl.style.display = isCustom ? "block" : "none";
        if (!isCustom) {
          categoryCustomEl.value = "";
        }
      }

      categoryEl.addEventListener("change", handleCategoryCustom);

      function startEdit(entry) {
        editingIdEl.value = entry.id;
        dateEl.value = entry.date;
        setType(entry.type);
        // 카테고리 처리(직접입력 포함)
        const list = CATEGORIES[entry.type] || [];
        if (list.includes(entry.category)) {
          categoryEl.value = entry.category;
          categoryCustomEl.value = "";
        } else {
          categoryEl.value = "직접입력";
          categoryCustomEl.value = entry.category || "";
        }
        handleCategoryCustom();

        amountEl.value = entry.amount;
        memoEl.value = entry.memo || "";

        submitBtn.textContent = "수정 저장";
        cancelEditBtn.style.display = "inline-block";

        setPage("add");
        toast("수정 모드로 전환");
      }

      function endEditMode() {
        editingIdEl.value = "";
        submitBtn.textContent = "저장";
        cancelEditBtn.style.display = "none";
      }

      cancelEditBtn.addEventListener("click", () => {
        endEditMode();
        entryForm.reset();
        dateEl.value = todayISO();
        setType("expense");
        refreshCategoryOptions();
        toast("수정 취소");
      });

      entryForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const type = typeEl.value;
        const date = dateEl.value || todayISO();

        let category = categoryEl.value;
        if (category === "직접입력") {
          category = (categoryCustomEl.value || "").trim();
        }
        const amount = Number(amountEl.value || 0);
        const memo = (memoEl.value || "").trim();

        if (!date) return toast("날짜를 입력해줘");
        if (!category) return toast("카테고리를 입력해줘");
        if (!Number.isFinite(amount) || amount <= 0) return toast("금액은 0보다 크게 입력해줘");

        const editingId = editingIdEl.value;

        if (editingId) {
          const idx = entries.findIndex((x) => x.id === editingId);
          if (idx >= 0) {
            entries[idx] = { ...entries[idx], type, date, category, amount, memo };
            toast("수정 완료");
          } else {
            toast("수정 대상이 없어 새로 저장할게");
            entries.unshift({ id: uid(), type, date, category, amount, memo, createdAt: Date.now() });
          }
          endEditMode();
        } else {
          entries.unshift({ id: uid(), type, date, category, amount, memo, createdAt: Date.now() });
          toast("저장 완료");
        }

        entries.sort((a, b) => (b.date || "").localeCompare(a.date || "") || (b.createdAt || 0) - (a.createdAt || 0));
        saveEntries(entries);

        entryForm.reset();
        dateEl.value = todayISO();
        setType(type);
        refreshCategoryOptions();

        renderAll();
        setPage("history");
      });

      // ---------- 내역(필터/리스트) ----------
      const historyMonthEl = $("#historyMonth");
      const historyTypeEl = $("#historyType");
      const historyQueryEl = $("#historyQuery");
      const historyListEl = $("#historyList");
      const historyCountEl = $("#historyCount");
      const historySumExpenseEl = $("#historySumExpense");
      const historySumIncomeEl = $("#historySumIncome");

      function getFilteredEntries({ month, type, q }) {
        const mq = (q || "").trim().toLowerCase();
        return entries.filter((e) => {
          if (month && monthISO(e.date) !== month) return false;
          if (type && type !== "all" && e.type !== type) return false;
          if (mq) {
            const hay = `${e.category || ""} ${e.memo || ""}`.toLowerCase();
            if (!hay.includes(mq)) return false;
          }
          return true;
        });
      }

      function renderHistory() {
        const month = historyMonthEl.value;
        const type = historyTypeEl.value;
        const q = historyQueryEl.value;

        const list = getFilteredEntries({ month, type, q });

        let sumExpense = 0;
        let sumIncome = 0;
        list.forEach((e) => {
          if (e.type === "expense") sumExpense += e.amount;
          else sumIncome += e.amount;
        });

        historyCountEl.textContent = `${list.length}건`;
        historySumExpenseEl.textContent = `지출 ${money(sumExpense)}`;
        historySumIncomeEl.textContent = `수입 ${money(sumIncome)}`;

        if (list.length === 0) {
          historyListEl.innerHTML = `
            <div class="empty">
              조건에 맞는 내역이 없어.<br/>
              상단 필터를 바꾸거나 "추가"에서 내역을 입력해줘.
            </div>
          `;
          return;
        }

        historyListEl.innerHTML = list.map(renderEntryItem).join("");
      }

      function renderEntryItem(e) {
        const isExpense = e.type === "expense";
        const sign = isExpense ? "-" : "+";
        const amtClass = isExpense ? "bad" : "good";
        const chipClass = isExpense ? "bad" : "good";
        const memo = (e.memo || "").trim();

        return `
          <div class="item" data-id="${escapeHtmlAttr(e.id)}">
            <div class="itemLeft">
              <div class="itemMeta">
                <span class="chip ${chipClass}">${isExpense ? "지출" : "수입"}</span>
                <span class="chip">${escapeHtml(e.date)}</span>
                <span class="chip">${escapeHtml(e.category || "")}</span>
              </div>
              <div class="itemTitle">${escapeHtml(e.category || "")}</div>
              <div class="itemMemo">${memo ? escapeHtml(memo) : "<span class='muted'>메모 없음</span>"}</div>
            </div>

            <div class="itemRight">
              <div class="amount ${amtClass}">${sign}${moneyFmt.format(Math.round(e.amount || 0))}원</div>
              <div class="miniActions">
                <button class="miniBtn" type="button" data-action="edit">편집</button>
                <button class="miniBtn danger" type="button" data-action="delete">삭제</button>
              </div>
            </div>
          </div>
        `;
      }

      historyListEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;

        const item = e.target.closest(".item");
        if (!item) return;

        const id = item.getAttribute("data-id");
        const action = btn.getAttribute("data-action");

        const entry = entries.find((x) => x.id === id);
        if (!entry) return toast("대상을 찾을 수 없어");

        if (action === "delete") {
          if (!confirm("이 내역을 삭제할까?")) return;
          entries = entries.filter((x) => x.id !== id);
          saveEntries(entries);
          renderAll();
          toast("삭제 완료");
          return;
        }

        if (action === "edit") {
          startEdit(entry);
        }
      });

      [historyMonthEl, historyTypeEl, historyQueryEl].forEach((el) => {
        el.addEventListener("input", () => renderHistory());
      });

      $("#quickToAdd").addEventListener("click", () => setPage("add"));

      // ---------- 대시보드 ----------
      const dashMonthEl = $("#dashMonth");
      const dashIncomeEl = $("#dashIncome");
      const dashExpenseEl = $("#dashExpense");
      const dashBalanceEl = $("#dashBalance");
      const topExpenseCatsEl = $("#topExpenseCats");
      const topIncomeCatsEl = $("#topIncomeCats");

      function sumByCategory(list) {
        /** @type {Record<string, number>} */
        const map = {};
        for (const e of list) {
          const k = (e.category || "기타").trim() || "기타";
          map[k] = (map[k] || 0) + (Number(e.amount) || 0);
        }
        return map;
      }

      function renderBars(container, map, emptyText) {
        const arr = Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, 8);
        if (arr.length === 0) {
          container.innerHTML = `<div class="empty">${escapeHtml(emptyText)}</div>`;
          return;
        }
        const max = Math.max(...arr.map((x) => x[1]), 1);

        container.innerHTML = arr.map(([name, val]) => {
          const pct = Math.max(0, Math.min(100, (val / max) * 100));
          return `
            <div class="barRow">
              <div>
                <div class="barLabel">
                  <span>${escapeHtml(name)}</span>
                  <span>${money(val)}</span>
                </div>
                <div class="barTrack"><div class="barFill" style="width:${pct.toFixed(1)}%"></div></div>
              </div>
              <div class="barAmt">${money(val)}</div>
            </div>
          `;
        }).join("");
      }

      function renderDashboard() {
        const m = dashMonthEl.value;
        const month = m || monthISO(todayISO());

        const monthEntries = entries.filter((e) => monthISO(e.date) === month);

        let income = 0;
        let expense = 0;
        const incomeList = [];
        const expenseList = [];

        for (const e of monthEntries) {
          if (e.type === "expense") {
            expense += e.amount || 0;
            expenseList.push(e);
          } else {
            income += e.amount || 0;
            incomeList.push(e);
          }
        }

        const balance = income - expense;

        dashIncomeEl.textContent = money(income);
        dashExpenseEl.textContent = money(expense);
        dashBalanceEl.textContent = money(balance);
        dashBalanceEl.classList.toggle("good", balance > 0);
        dashBalanceEl.classList.toggle("bad", balance < 0);

        renderBars(topExpenseCatsEl, sumByCategory(expenseList), "이번 달 지출 내역이 없어.");
        renderBars(topIncomeCatsEl, sumByCategory(incomeList), "이번 달 수입 내역이 없어.");
      }

      dashMonthEl.addEventListener("input", () => {
        // 히스토리 월도 같이 맞춰주면 편함
        historyMonthEl.value = dashMonthEl.value;
        renderAll();
      });

      // ---------- 설정(내보내기/가져오기/삭제) ----------
      function download(filename, content, mime = "text/plain;charset=utf-8") {
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1200);
      }

      $("#exportJson").addEventListener("click", () => {
        const payload = JSON.stringify({ exportedAt: new Date().toISOString(), entries }, null, 2);
        download(`ledger-backup-${monthISO(todayISO())}.json`, payload, "application/json;charset=utf-8");
        toast("JSON 내보내기 완료");
      });

      $("#exportCsv").addEventListener("click", () => {
        const header = ["date", "type", "category", "amount", "memo"];
        const rows = entries.map((e) => [
          e.date || "",
          e.type || "",
          e.category || "",
          String(e.amount || 0),
          (e.memo || "").replace(/\r?\n/g, " "),
        ]);

        const csv = [header, ...rows].map((cols) => cols.map(csvCell).join(",")).join("\n");
        download(`ledger-${monthISO(todayISO())}.csv`, csv, "text/csv;charset=utf-8");
        toast("CSV 내보내기 완료");
      });

      const importFileEl = $("#importFile");
      $("#importBtn").addEventListener("click", async () => {
        const file = importFileEl.files && importFileEl.files[0];
        if (!file) return toast("JSON 파일을 먼저 선택해줘");

        const text = await file.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          return toast("JSON 형식이 아니야");
        }

        const arr = Array.isArray(data) ? data : (Array.isArray(data.entries) ? data.entries : null);
        if (!arr) return toast("가져올 entries 배열을 찾지 못했어");

        const cleaned = arr
          .filter((x) => x && typeof x === "object")
          .map((x) => ({
            id: String(x.id || uid()),
            date: String(x.date || ""),
            type: x.type === "income" ? "income" : "expense",
            category: String(x.category || "기타"),
            amount: Number(x.amount || 0),
            memo: String(x.memo || ""),
            createdAt: Number(x.createdAt || Date.now()),
          }))
          .filter((x) => x.date && Number.isFinite(x.amount) && x.amount >= 0);

        if (cleaned.length === 0) return toast("가져올 유효한 데이터가 없어");

        const merge = confirm("가져온 데이터를 기존 내역에 합칠까?\n확인: 합치기\n취소: 덮어쓰기");
        if (merge) {
          const byId = new Map(entries.map((e) => [e.id, e]));
          for (const e of cleaned) {
            if (byId.has(e.id)) {
              // id 충돌이면 새 id로 추가
              byId.set(uid(), { ...e, id: uid(), createdAt: Date.now() });
            } else {
              byId.set(e.id, e);
            }
          }
          entries = Array.from(byId.values());
        } else {
          if (!confirm("정말로 기존 내역을 덮어쓸까?")) return;
          entries = cleaned;
        }

        entries.sort((a, b) => (b.date || "").localeCompare(a.date || "") || (b.createdAt || 0) - (a.createdAt || 0));
        saveEntries(entries);
        importFileEl.value = "";
        renderAll();
        toast("가져오기 완료");
      });

      $("#clearAll").addEventListener("click", () => {
        if (!confirm("저장된 내역을 전부 삭제할까?")) return;
        entries = [];
        saveEntries(entries);
        renderAll();
        toast("전체 삭제 완료");
      });

      // ---------- 유틸 ----------
      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function escapeHtmlAttr(str) {
        // 속성용(기본 escape로 충분)
        return escapeHtml(str).replaceAll("`", "&#096;");
      }
      function csvCell(v) {
        const s = String(v ?? "");
        const escaped = s.replaceAll('"', '""');
        return `"${escaped}"`;
      }

      // ---------- 초기값/렌더 ----------
      function init() {
        // 기본 날짜/월
        dateEl.value = todayISO();

        const m = monthISO(todayISO());
        dashMonthEl.value = m;
        historyMonthEl.value = m;

        setType("expense");
        refreshCategoryOptions();

        renderAll();
      }

      function renderAll() {
        renderDashboard();
        renderHistory();
      }

      init();
    })();
  </script>
</body>
  </html>
